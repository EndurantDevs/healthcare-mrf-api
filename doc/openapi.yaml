openapi: 3.0.3
info:
  title: HealthPorta Healthcare MRF API
  version: "1.0.0"
  description: |
    OpenAPI description for the HealthPorta Healthcare MRF API.  The API
    is versioned under `/api/v1` and served by a Sanic application.  All
    endpoints return JSON.  Unless noted otherwise, error responses use
    the `Error` schema.
servers:
  - url: http://localhost:8085/api/v1
paths:
  /healthcheck/:
    get:
      summary: Health check and release metadata
      responses:
        '200':
          description: Service status payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthcheckResponse'
  /plan/:
    get:
      summary: Platform plan import status
      responses:
        '200':
          description: Summary of plan, network, and import log metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlanIndexStatus'
  /plan/all:
    get:
      summary: List all plans
      responses:
        '200':
          description: Array of plan records
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PlanRecord'
  /plan/all/variants:
    get:
      summary: List plan variants with optional pagination
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
          description: Maximum number of rows to return
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
          description: Offset to apply when paging results
      responses:
        '200':
          description: Array of plan variant summaries
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PlanVariantSummary'
  /plan/network/id/{checksum}:
    get:
      summary: Fetch network details by checksum
      parameters:
        - name: checksum
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Network entry and issuer metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlanNetworkEntry'
        '404':
          description: Network checksum not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /plan/network/multiple/{checksums}:
    get:
      summary: Fetch multiple network entries
      parameters:
        - name: checksums
          in: path
          required: true
          schema:
            type: string
          description: Comma-separated list of network checksum integers
      responses:
        '200':
          description: Array of network entries
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PlanNetworkEntry'
        '404':
          description: None of the requested checksums returned data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /plan/network/autocomplete:
    get:
      summary: Autocomplete plans by marketing name or plan ID
      parameters:
        - name: query
          in: query
          required: true
          schema:
            type: string
          description: Text fragment to match against plan marketing name or ID
        - name: state
          in: query
          schema:
            type: string
            minLength: 2
            maxLength: 2
          description: Optional two-letter state filter
        - name: zip_code
          in: query
          schema:
            type: string
          description: Optional ZIP code filter; ignored if `state` supplied
      responses:
        '200':
          description: Autocomplete payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlanAutocompleteResponse'
  /plan/search:
    get:
      summary: Search plans with optional demographic filters
      parameters:
        - name: age
          in: query
          schema:
            type: integer
            minimum: 0
          description: Member age used for pricing filters
        - name: rating_area
          in: query
          schema:
            type: string
          description: Rating area identifier
        - name: zip_code
          in: query
          schema:
            type: string
          description: ZIP code value for geographic filtering
        - name: year
          in: query
          schema:
            type: integer
          description: Plan year to match
        - name: state
          in: query
          schema:
            type: string
            maxLength: 2
          description: Two-letter state filter (auto-derived from zip_code when omitted)
        - name: issuer_id
          in: query
          schema:
            type: integer
          description: Restrict results to a specific issuer
        - name: plan_id
          in: query
          schema:
            type: string
          description: Partial or full plan identifier search
        - name: q
          in: query
          schema:
            type: string
          description: Case-insensitive substring match against plan marketing name
        - name: limit
          in: query
          schema:
            type: integer
          description: Maximum number of rows per page (defaults to 100)
        - name: page
          in: query
          schema:
            type: integer
          description: 1-based page number (defaults to 1)
        - name: order
          in: query
          schema:
            type: string
            enum: [asc, desc]
          description: Sort direction for results (defaults to asc)
        - name: order_by
          in: query
          schema:
            type: string
            enum: [plan_id, marketing_name, state, year, deductible, moop, premium_min, premium_max]
          description: Field to order by (defaults to plan_id)
        - name: premium_min
          in: query
          schema:
            type: number
          description: Minimum aggregated monthly premium allowed for the plan
        - name: premium_max
          in: query
          schema:
            type: number
          description: Maximum aggregated monthly premium allowed for the plan
        - name: has_adult_dental
          in: query
          schema:
            type: boolean
          description: Require adult dental coverage metadata
        - name: has_child_dental
          in: query
          schema:
            type: boolean
          description: Require pediatric dental coverage metadata
        - name: has_adult_vision
          in: query
          schema:
            type: boolean
          description: Require adult vision coverage metadata
        - name: has_child_vision
          in: query
          schema:
            type: boolean
          description: Require pediatric vision coverage metadata
        - name: telehealth_supported
          in: query
          schema:
            type: boolean
          description: Filter by plans that list telehealth/virtual visits in benefits
        - name: plan_types
          in: query
          schema:
            type: array
            items:
              type: string
          style: form
          explode: true
          description: Repeatable or comma-separated list of plan types (HMO, PPO, etc.)
        - name: metal_levels
          in: query
          schema:
            type: array
            items:
              type: string
          style: form
          explode: true
          description: Repeatable or comma-separated list of metal levels (e.g., Bronze, Silver)
        - name: csr_variations
          in: query
          schema:
            type: array
            items:
              type: string
          style: form
          explode: true
          description: CSR variation identifiers to match
        - name: is_hsa
          in: query
          schema:
            type: boolean
          description: Restrict to plans flagged as HSA-eligible
        - name: is_dental_only
          in: query
          schema:
            type: boolean
          description: Restrict to dental-only plans
        - name: is_catastrophic
          in: query
          schema:
            type: boolean
          description: Restrict to catastrophic metal level plans
        - name: is_on_exchange
          in: query
          schema:
            type: boolean
          description: Filter by plans sold on the exchange marketplace
        - name: is_off_exchange
          in: query
          schema:
            type: boolean
          description: Filter by plans sold off exchange
        - name: issuer_ids
          in: query
          schema:
            type: array
            items:
              type: integer
          style: form
          explode: true
          description: Repeatable or comma-separated issuer IDs; may be combined with issuer_id
        - name: deductible_min
          in: query
          schema:
            type: number
          description: Minimum in-network individual deductible
        - name: deductible_max
          in: query
          schema:
            type: number
          description: Maximum in-network individual deductible
        - name: moop_min
          in: query
          schema:
            type: number
          description: Minimum in-network individual maximum out-of-pocket
        - name: moop_max
          in: query
          schema:
            type: number
          description: Maximum in-network individual maximum out-of-pocket
      responses:
        '200':
          description: Paginated plan search payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlanSearchResponse'
        '400':
          description: Invalid numeric filters (age/year) supplied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /formulary/ids:
    get:
      summary: Search formularies by issuer, plan, year, or drug keyword
      parameters:
        - name: issuer_id
          in: query
          schema:
            type: integer
        - name: plan_id
          in: query
          schema:
            type: string
        - name: year
          in: query
          schema:
            type: integer
        - name: state
          in: query
          schema:
            type: string
            minLength: 2
            maxLength: 2
        - name: drug
          in: query
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
        - name: page_size
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 200
      responses:
        '200':
          description: Paginated list of formularies
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FormularyListResponse'
  /formulary/id/{formulary_id}:
    get:
      summary: Retrieve formulary metadata and linked plan
      parameters:
        - name: formulary_id
          in: path
          required: true
          schema:
            type: string
          description: Combination of plan identifier and year (e.g. PLAN123:2025)
      responses:
        '200':
          description: Formulary detail payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FormularyDetail'
        '404':
          description: Formulary not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /formulary/id/{formulary_id}/drugs:
    get:
      summary: List drugs covered by a formulary
      parameters:
        - name: formulary_id
          in: path
          required: true
          schema:
            type: string
        - name: tier
          in: query
          schema:
            type: string
        - name: pharmacy_type
          in: query
          schema:
            type: string
        - name: authorization_required
          in: query
          schema:
            type: boolean
        - name: step_therapy
          in: query
          schema:
            type: boolean
        - name: quantity_limit
          in: query
          schema:
            type: boolean
        - name: sort
          in: query
          schema:
            type: string
            enum: [name, tier]
        - name: order
          in: query
          schema:
            type: string
            enum: [asc, desc]
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
        - name: page_size
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 200
      responses:
        '200':
          description: Paginated list of formulary drugs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FormularyDrugList'
        '404':
          description: Formulary not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /formulary/id/{formulary_id}/drugs/{rxnorm_id}:
    get:
      summary: Retrieve formulary-specific drug information
      parameters:
        - name: formulary_id
          in: path
          required: true
          schema:
            type: string
        - name: rxnorm_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Drug detail within the formulary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FormularyDrugDetail'
        '404':
          description: Drug not present within the formulary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /formulary/id/{formulary_id}/summary:
    get:
      summary: Retrieve aggregate metrics for a formulary
      parameters:
        - name: formulary_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Aggregate statistics for the formulary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FormularySummary'
        '404':
          description: Formulary not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /formulary/plan/{plan_id}/drug/{rxnorm_id}:
    get:
      summary: Determine if a plan formulary covers a specific drug
      parameters:
        - name: plan_id
          in: path
          required: true
          schema:
            type: string
        - name: rxnorm_id
          in: path
          required: true
          schema:
            type: string
        - name: year
          in: query
          schema:
            type: integer
          description: Optional business year; when omitted the most recent plan year is used
      responses:
        '200':
          description: Coverage status and metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlanDrugCoverage'
        '404':
          description: Plan or formulary not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /formulary/drugs/{rxnorm_id}:
    get:
      summary: List every formulary covering an RxNorm identifier
      parameters:
        - name: rxnorm_id
          in: path
          required: true
          schema:
            type: string
        - name: year
          in: query
          schema:
            type: integer
        - name: state
          in: query
          schema:
            type: string
            minLength: 2
            maxLength: 2
        - name: issuer_id
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: Matching formularies
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FormularyCrosswalk'
        '404':
          description: Drug not found in any formulary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /formulary/statistics:
    get:
      summary: Retrieve high-level formulary statistics
      parameters:
        - name: year
          in: query
          schema:
            type: integer
        - name: state
          in: query
          schema:
            type: string
            minLength: 2
            maxLength: 2
        - name: issuer_id
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: Formulary analytics snapshot
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FormularyStatistics'
  /plan/price/{plan_id}:
    get:
      summary: Retrieve price rows for a plan
      parameters:
        - name: plan_id
          in: path
          required: true
          schema:
            type: string
        - name: age
          in: query
          schema:
            type: integer
          description: Optional age filter; validated but not applied server-side
        - name: rating_area
          in: query
          schema:
            type: string
          description: Optional rating area filter; validated but not applied server-side
      responses:
        '200':
          description: Array of price entries
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PlanPriceEntry'
        '400':
          description: Invalid age supplied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /plan/price/{plan_id}/year:
    get:
      summary: Retrieve price rows for a plan and year
      parameters:
        - name: plan_id
          in: path
          required: true
          schema:
            type: string
        - name: age
          in: query
          schema:
            type: integer
          description: Optional age filter; validated but not applied server-side
        - name: rating_area
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Array of price entries
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PlanPriceEntry'
        '400':
          description: Invalid age or year supplied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /plan/price/bulk:
    post:
      summary: Retrieve price rows for multiple plans
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                plan_ids:
                  type: array
                  items:
                    type: string
                year:
                  type: integer
                age:
                  type: integer
                rating_area:
                  type: string
              required: [plan_ids]
      responses:
        '200':
          description: Price rows keyed by plan_id
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlanPriceBulkResponse'
        '400':
          description: Invalid request payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /plan/id/{plan_id}:
    get:
      summary: Retrieve plan metadata
      parameters:
        - name: plan_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Plan metadata including variants and networks
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlanDetail'
        '404':
          description: Plan not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /plan/id/{plan_id}/{year}:
    get:
      summary: Retrieve plan metadata for a specific year
      parameters:
        - name: plan_id
          in: path
          required: true
          schema:
            type: string
        - name: year
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Plan metadata filtered to the given year
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlanDetail'
        '404':
          description: Plan not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /plan/id/{plan_id}/{year}/{variant}:
    get:
      summary: Retrieve a specific plan variant
      parameters:
        - name: plan_id
          in: path
          required: true
          schema:
            type: string
        - name: year
          in: path
          required: true
          schema:
            type: integer
        - name: variant
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Plan metadata including variant attributes and benefits
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlanDetail'
        '404':
          description: Plan or variant not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /import/:
    get:
      summary: Summarize last import statistics
      responses:
        '200':
          description: Import statistics and state-level tallies
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImporterStats'
  /import/issuer/{issuer_id}:
    get:
      summary: Fetch import information for a specific issuer
      parameters:
        - name: issuer_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Issuer metadata and import errors
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImporterIssuerDetail'
        '404':
          description: Issuer not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /issuer/id/{issuer_id}:
    get:
      summary: Retrieve issuer details and plans
      parameters:
        - name: issuer_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Issuer data, import errors, and plans
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IssuerDetail'
        '404':
          description: Issuer not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /issuer/:
    get:
      summary: List issuers across all states
      responses:
        '200':
          description: Array of issuer summaries
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/IssuerSummary'
        '404':
          description: No issuers found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /issuer/state/{state}:
    get:
      summary: List issuers for a specific state
      parameters:
        - name: state
          in: path
          required: true
          schema:
            type: string
            minLength: 2
            maxLength: 2
      responses:
        '200':
          description: Array of issuer summaries for the state
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/IssuerSummary'
        '404':
          description: No issuers found for the state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /geo/get:
    get:
      summary: Echo geo metadata for quick status checks
      parameters:
        - name: zip_code
          in: query
          required: true
          schema:
            type: number
          description: ZIP code provided as a numeric value
        - name: lat
          in: query
          required: true
          schema:
            type: number
          description: Latitude to report back in the response metadata
      responses:
        '200':
          description: Minimal geo response with release metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GeoPingResponse'
  /geo/zip/{zip_code}:
    get:
      summary: Look up ZIP centroid and state
      parameters:
        - name: zip_code
          in: path
          required: true
          schema:
            type: string
          description: 5-digit ZIP code (padding handled server-side)
      responses:
        '200':
          description: ZIP geolocation payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GeoZipResponse'
        '404':
          description: ZIP code not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Underlying TIGER tables unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /geo/city:
    get:
      summary: List ZIP codes for a given city and optional state
      parameters:
        - name: city
          in: query
          required: true
          schema:
            type: string
          description: City name to search (case insensitive)
        - name: state
          in: query
          required: false
          schema:
            type: string
            maxLength: 2
          description: Optional 2-letter state abbreviation to narrow matches
      responses:
        '200':
          description: Matching ZIP codes for the requested city/state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GeoCityResponse'
        '404':
          description: No ZIPs found for the requested filters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /geo/states:
    get:
      summary: Aggregated ZIP and city counts per state
      parameters:
        - name: sort
          in: query
          schema:
            type: string
            enum: [population, zip_count, state]
          description: Field used to order the states (defaults to population)
        - name: order
          in: query
          schema:
            type: string
            enum: [asc, desc]
          description: Sort direction (defaults to desc)
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
          description: Optional maximum number of rows to return
        - name: top_zip_limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 10
          description: Number of top ZIP codes (by population) to include per state (default 5)
      responses:
        '200':
          description: Aggregated state-level geo metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GeoStateListResponse'
        '400':
          description: Invalid sort/order parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /geo/state/{state}/cities:
    get:
      summary: Top cities in a state by population (based on local geo data)
      parameters:
        - name: state
          in: path
          required: true
          schema:
            type: string
            maxLength: 2
          description: Two-letter state abbreviation
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 200
          description: Number of cities to include (defaults to 20, max 200)
      responses:
        '200':
          description: Ordered list of cities with population/ZIP counts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GeoStateCitiesResponse'
        '404':
          description: No city data found for the requested state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /nucc/:
    get:
      summary: NUCC endpoint heartbeat
      responses:
        '200':
          description: Empty object (endpoint reserved for future use)
          content:
            application/json:
              schema:
                type: object
  /nucc/all:
    get:
      summary: List NUCC taxonomy codes
      responses:
        '200':
          description: Array of NUCC taxonomy entries
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/NuccTaxonomy'
  /npi/:
    get:
      summary: NPI index status metadata
      responses:
        '200':
          description: Counts and release metadata for NPI data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NpiIndexStatus'
  /npi/active_pharmacists:
    get:
      summary: Count pharmacists colocated with pharmacies using shared phone numbers
      parameters:
        - name: state
          in: query
          schema:
            type: string
            minLength: 2
            maxLength: 2
          description: Restrict match to a two-letter state code
        - name: specialization
          in: query
          schema:
            type: string
          description: NUCC specialization name to use instead of default pharmacist classification
      responses:
        '200':
          description: Count payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CountResponse'
  /npi/pharmacists_in_pharmacies:
    get:
      summary: Count pharmacists colocated with pharmacies filtered by pharmacy name
      parameters:
        - name: name_like
          in: query
          required: true
          schema:
            type: string
          description: Case-insensitive fragment matched against pharmacy names
      responses:
        '200':
          description: Count payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CountResponse'
  /npi/pharmacists_per_pharmacy:
    get:
      summary: Histogram of pharmacist counts per pharmacy
      parameters:
        - name: state
          in: query
          schema:
            type: string
            minLength: 2
            maxLength: 2
          description: Optional state filter applied to pharmacies
        - name: name_like
          in: query
          schema:
            type: string
          description: Case-insensitive fragment matched against pharmacy names
      responses:
        '200':
          description: Array of pharmacist count buckets
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PharmacistBucket'
  /npi/all:
    get:
      summary: Search NPI directory
      parameters:
        - name: count_only
          in: query
          schema:
            type: number
          description: When non-zero, only the aggregate count is returned
        - name: format
          in: query
          schema:
            type: string
            enum: [classification, full_taxonomy]
          description: Optional aggregation mode for `count_only`
        - name: name_like
          in: query
          schema:
            type: string
          description: Case-insensitive fragment matched against provider names
        - name: start
          in: query
          schema:
            type: number
          description: Offset applied to search results (default 0)
        - name: limit
          in: query
          schema:
            type: number
          description: Maximum number of rows to return (default 0 = all)
        - name: classification
          in: query
          schema:
            type: string
          description: NUCC classification filter
        - name: specialization
          in: query
          schema:
            type: string
          description: NUCC specialization filter
        - name: section
          in: query
          schema:
            type: string
        - name: display_name
          in: query
          schema:
            type: string
        - name: plan_network
          in: query
          schema:
            type: string
          description: Comma-separated list of plan network checksum integers
        - name: has_insurance
          in: query
          schema:
            type: string
          description: Truthy flag that filters out NPIs with empty plan networks
        - name: city
          in: query
          schema:
            type: string
        - name: state
          in: query
          schema:
            type: string
            minLength: 2
            maxLength: 2
        - name: codes
          in: query
          schema:
            type: string
          description: Comma-separated NUCC taxonomy codes to match
      responses:
        '200':
          description: Either a count or full search payload
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/NpiCountResponse'
                  - $ref: '#/components/schemas/NpiSearchResponse'
  /npi/near/:
    get:
      summary: Find NPIs near a point or ZIP centroid
      parameters:
        - name: long
          in: query
          schema:
            type: number
          description: Longitude of the search point
        - name: lat
          in: query
          schema:
            type: number
          description: Latitude of the search point
        - name: codes
          in: query
          schema:
            type: string
          description: Comma-separated NUCC taxonomy codes to filter results
        - name: plan_network
          in: query
          schema:
            type: string
          description: Comma-separated plan network checksums
        - name: classification
          in: query
          schema:
            type: string
        - name: section
          in: query
          schema:
            type: string
        - name: display_name
          in: query
          schema:
            type: string
        - name: name_like
          in: query
          schema:
            type: string
          description: Case-insensitive fragment matched against provider names
        - name: exclude_npi
          in: query
          schema:
            type: integer
          description: NPI to exclude from results
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
          description: Maximum result count (defaults to 5)
        - name: zip_codes
          in: query
          schema:
            type: string
          description: Comma-separated ZIP codes used when coordinates are missing
        - name: radius
          in: query
          schema:
            type: integer
          description: Search radius in miles (defaults to 10, overridden to 1000 for ZIP lookups)
      responses:
        '200':
          description: Array of nearby NPI entries
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/NpiNearResult'
  /npi/id/{npi}/full_taxonomy:
    get:
      summary: Retrieve taxonomy list for an NPI
      parameters:
        - name: npi
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Array of taxonomy entries joined with NUCC metadata
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/NpiTaxonomyWithNucc'
  /npi/plans_by_npi/{npi}:
    get:
      summary: Retrieve plan associations for an NPI
      parameters:
        - name: npi
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Plan and issuer data for the NPI
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NpiPlansResponse'
  /npi/id/{npi}:
    get:
      summary: Retrieve a detailed NPI profile
      parameters:
        - name: npi
          in: path
          required: true
          schema:
            type: integer
        - name: force_address_update
          in: query
          schema:
            type: integer
          description: When non-zero, forces address geocoding refresh
      responses:
        '200':
          description: NPI detail payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NpiRecord'
        '404':
          description: NPI not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
components:
  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
        details:
          type: string
      additionalProperties: true
    CountResponse:
      type: object
      properties:
        count:
          type: integer
    PharmacistBucket:
      type: object
      properties:
        pharmacist_group:
          type: string
        pharmacy_count:
          type: integer
    HealthcheckResponse:
      type: object
      properties:
        date:
          type: string
          format: date-time
        release:
          type: string
        environment:
          type: string
        database:
          type: object
          properties:
            status:
              type: string
            details:
              type: string
          additionalProperties: true
    PlanIndexStatus:
      type: object
      properties:
        date:
          type: string
          format: date-time
        release:
          type: string
        environment:
          type: string
        plan_count:
          type: integer
        plans_network_count:
          type: integer
        import_log_errors:
          type: integer
    PlanRecord:
      type: object
      properties:
        plan_id:
          type: string
        marketing_name:
          type: string
        issuer_id:
          type: integer
        state:
          type: string
      additionalProperties: true
    PlanVariantSummary:
      type: object
      properties:
        marketing_name:
          type: string
        plan_id:
          type: string
        full_plan_id:
          type: string
        year:
          type: integer
    PlanNetworkEntry:
      type: object
      properties:
        checksum:
          type: integer
        network_tier:
          type: string
        issuer:
          type: integer
        issuer_name:
          type: string
        issuer_marketing_name:
          type: string
        issuer_display_name:
          type: string
        issuer_state:
          type: string
        plans:
          type: array
          items:
            type: object
            properties:
              plan_id:
                type: string
              year:
                type: integer
    PlanAutocompleteResponse:
      type: object
      properties:
        plans:
          type: array
          items:
            type: object
            properties:
              plan_id:
                type: string
              marketing_name:
                type: string
              network_checksum:
                type: object
            additionalProperties:
              type: string
            additionalProperties: true
    PlanDrugRecord:
      type: object
      properties:
        plan_id:
          type: string
        plan_id_type:
          type: string
        rxnorm_id:
          type: string
        drug_name:
          type: string
        drug_tier:
          type: string
        prior_authorization:
          type: boolean
          nullable: true
        step_therapy:
          type: boolean
          nullable: true
        quantity_limit:
          type: boolean
          nullable: true
        last_updated_on:
          type: string
          format: date-time
          nullable: true
    PlanSearchResponse:
      type: object
      properties:
        total:
          type: integer
        results:
          type: array
          items:
            $ref: '#/components/schemas/PlanSearchResult'
        issuers:
          type: array
          items:
            $ref: '#/components/schemas/PlanIssuerFacet'
        facets:
          $ref: '#/components/schemas/PlanSearchFacets'
        applied_filters:
          type: object
          additionalProperties: true
        warnings:
          type: array
          items:
            $ref: '#/components/schemas/PlanSearchWarning'
    PlanSearchResult:
      type: object
      properties:
        plan_id:
          type: string
        price_range:
          type: object
          properties:
            min:
              type: number
            max:
              type: number
        has_adult_dental:
          type: boolean
          nullable: true
        has_child_dental:
          type: boolean
          nullable: true
        has_adult_vision:
          type: boolean
          nullable: true
        has_child_vision:
          type: boolean
          nullable: true
        telehealth_supported:
          type: boolean
          nullable: true
        is_hsa:
          type: boolean
          nullable: true
        is_dental_only:
          type: boolean
          nullable: true
        is_catastrophic:
          type: boolean
          nullable: true
        is_on_exchange:
          type: boolean
          nullable: true
        is_off_exchange:
          type: boolean
          nullable: true
        market_coverage:
          type: string
          nullable: true
        deductible_inn_individual:
          type: number
          nullable: true
        moop_inn_individual:
          type: number
          nullable: true
        attributes:
          type: object
          additionalProperties:
            type: object
            properties:
              attr_value:
                type: string
                nullable: true
              human_attr_name:
                type: string
                nullable: true
            additionalProperties: true
        plan_benefits:
          type: object
          additionalProperties:
            type: object
            additionalProperties: true
      additionalProperties: true
    PlanIssuerFacet:
      type: object
      properties:
        issuer_id:
          type: integer
          nullable: true
        issuer_name:
          type: string
          nullable: true
        plan_count:
          type: integer
      additionalProperties: false
    PlanSearchWarning:
      type: object
      properties:
        code:
          type: string
        message:
          type: string
      required: [code, message]
      additionalProperties: false
    PlanSearchFacets:
      type: object
      properties:
        plan_types:
          type: array
          items:
            $ref: '#/components/schemas/PlanFacetValueCount'
        metal_levels:
          type: array
          items:
            $ref: '#/components/schemas/PlanFacetValueCount'
        csr_variations:
          type: array
          items:
            $ref: '#/components/schemas/PlanFacetValueCount'
        boolean_filters:
          $ref: '#/components/schemas/PlanBooleanFacetCounts'
      additionalProperties: false
    PlanFacetValueCount:
      type: object
      properties:
        value:
          type: string
          nullable: true
        count:
          type: integer
      required: [value, count]
      additionalProperties: false
    PlanBooleanFacetCounts:
      type: object
      properties:
        has_adult_dental:
          $ref: '#/components/schemas/BooleanFacetCounts'
        has_child_dental:
          $ref: '#/components/schemas/BooleanFacetCounts'
        has_adult_vision:
          $ref: '#/components/schemas/BooleanFacetCounts'
        has_child_vision:
          $ref: '#/components/schemas/BooleanFacetCounts'
        telehealth_supported:
          $ref: '#/components/schemas/BooleanFacetCounts'
        is_hsa:
          $ref: '#/components/schemas/BooleanFacetCounts'
        is_dental_only:
          $ref: '#/components/schemas/BooleanFacetCounts'
        is_catastrophic:
          $ref: '#/components/schemas/BooleanFacetCounts'
        is_on_exchange:
          $ref: '#/components/schemas/BooleanFacetCounts'
        is_off_exchange:
          $ref: '#/components/schemas/BooleanFacetCounts'
      additionalProperties: false
    BooleanFacetCounts:
      type: object
      properties:
        true:
          type: integer
        false:
          type: integer
        null:
          type: integer
      required: [true, false, null]
      additionalProperties: false
    PlanPriceEntry:
      type: object
      properties:
        plan_id:
          type: string
        year:
          type: integer
        rating_area_id:
          type: string
        individual_rate:
          type: number
      additionalProperties: true
    PlanPriceBulkResponse:
      type: object
      properties:
        results:
          type: object
          additionalProperties:
            type: array
            items:
              $ref: '#/components/schemas/PlanPriceEntry'
        missing:
          type: array
          items:
            type: string
      required: [results, missing]
      additionalProperties: false
    PlanDetail:
      type: object
      properties:
        plan_id:
          type: string
        year:
          type: integer
        issuer_id:
          type: integer
        issuer_name:
          type: string
        network_checksum:
          type: object
          additionalProperties:
            type: string
        variants:
          type: array
          items:
            type: string
        variant_attributes:
          type: object
          additionalProperties:
            type: object
            properties:
              attr_value:
                type: string
              human_attr_name:
                type: string
        variant_benefits:
          type: object
          additionalProperties:
            type: object
            additionalProperties: true
        formulary:
          type: array
          items:
            type: object
            additionalProperties: true
      additionalProperties: true
    TierDescriptor:
      type: object
      properties:
        tier_slug:
          type: string
          enum: [tier_1, tier_2, tier_3, tier_4, tier_5, tier_6, generic, preferred_generic, non_preferred_generic, brand, preferred_brand, non_preferred_brand, specialty, preferred_specialty, non_preferred_specialty, other, unknown]
        tier_label:
          type: string
      required: [tier_slug, tier_label]
      additionalProperties: false
    TierBreakdownEntry:
      allOf:
        - $ref: '#/components/schemas/TierDescriptor'
        - type: object
          properties:
            drug_count:
              type: integer
          required: [drug_count]
          additionalProperties: false
    PharmacyBreakdownEntry:
      type: object
      properties:
        pharmacy_type:
          type: string
        count:
          type: integer
      required: [pharmacy_type, count]
      additionalProperties: false
    FormularyRecord:
      type: object
      properties:
        formulary_id:
          type: string
        formulary_uri:
          type: string
        plan_id:
          type: string
        year:
          type: integer
        marketing_name:
          type: string
        state:
          type: string
        issuer:
          type: object
          properties:
            issuer_id:
              type: integer
            issuer_name:
              type: string
            issuer_marketing_name:
              type: string
          additionalProperties: false
        drug_count:
          type: integer
        last_updated:
          type: string
          format: date-time
          nullable: true
      required: [formulary_id, formulary_uri, plan_id, year, marketing_name, state, issuer, drug_count]
      additionalProperties: false
    FormularyListResponse:
      type: object
      properties:
        total:
          type: integer
        items:
          type: array
          items:
            $ref: '#/components/schemas/FormularyRecord'
      required: [total, items]
      additionalProperties: false
    FormularyDetail:
      allOf:
        - $ref: '#/components/schemas/FormularyRecord'
        - type: object
          properties:
            plan:
              type: object
              properties:
                plan_id:
                  type: string
                year:
                  type: integer
                marketing_name:
                  type: string
                state:
                  type: string
                summary_url:
                  type: string
                  nullable: true
                marketing_url:
                  type: string
                  nullable: true
              additionalProperties: false
            available_tiers:
              type: array
              items:
                $ref: '#/components/schemas/TierDescriptor'
            available_pharmacy_types:
              type: array
              items:
                type: string
          required: [plan, available_tiers, available_pharmacy_types]
          additionalProperties: false
    FormularyDrug:
      type: object
      properties:
        rxnorm_id:
          type: string
        drug_name:
          type: string
        drug_tier:
          type: string
        drug_tier_slug:
          type: string
          enum: [tier_1, tier_2, tier_3, tier_4, tier_5, tier_6, generic, preferred_generic, non_preferred_generic, brand, preferred_brand, non_preferred_brand, specialty, preferred_specialty, non_preferred_specialty, other, unknown]
        prior_authorization:
          type: boolean
          nullable: true
        step_therapy:
          type: boolean
          nullable: true
        quantity_limit:
          type: boolean
          nullable: true
        last_updated:
          type: string
          format: date-time
          nullable: true
      required: [rxnorm_id, drug_name, drug_tier, drug_tier_slug]
      additionalProperties: false
    FormularyDrugList:
      type: object
      properties:
        formulary_id:
          type: string
        formulary_uri:
          type: string
        page:
          type: integer
        page_size:
          type: integer
        total:
          type: integer
        available_pharmacy_types:
          type: array
          items:
            type: string
        items:
          type: array
          items:
            $ref: '#/components/schemas/FormularyDrug'
      required: [formulary_id, formulary_uri, page, page_size, total, items]
      additionalProperties: false
    FormularyDrugDetail:
      allOf:
        - $ref: '#/components/schemas/FormularyDrug'
        - type: object
          properties:
            available_pharmacy_types:
              type: array
              items:
                type: string
            linked_plans:
              type: array
              items:
                type: object
                properties:
                  plan_id:
                    type: string
                  year:
                    type: integer
                required: [plan_id, year]
                additionalProperties: false
          required: [available_pharmacy_types, linked_plans]
          additionalProperties: false
    FormularySummary:
      type: object
      properties:
        formulary_id:
          type: string
        formulary_uri:
          type: string
        total_drugs:
          type: integer
        tiers:
          type: array
          items:
            $ref: '#/components/schemas/TierBreakdownEntry'
        authorization_requirements:
          type: object
          properties:
            required:
              type: integer
            not_required:
              type: integer
          additionalProperties: false
        step_therapy:
          type: object
          properties:
            required:
              type: integer
            not_required:
              type: integer
          additionalProperties: false
        quantity_limits:
          type: object
          properties:
            has_limit:
              type: integer
            no_limit:
              type: integer
          additionalProperties: false
        pharmacy_types:
          type: array
          items:
            $ref: '#/components/schemas/PharmacyBreakdownEntry'
      required: [formulary_id, formulary_uri, total_drugs, tiers, authorization_requirements, step_therapy, quantity_limits, pharmacy_types]
      additionalProperties: false
    FormularyCrosswalk:
      type: object
      properties:
        rxnorm_id:
          type: string
        formularies:
          type: array
          items:
            type: object
            properties:
              formulary_id:
                type: string
              formulary_uri:
                type: string
              plan_id:
                type: string
              year:
                type: integer
              plan_marketing_name:
                type: string
              state:
                type: string
              issuer:
                type: object
                properties:
                  issuer_id:
                    type: integer
                  issuer_name:
                    type: string
                additionalProperties: false
              drug_tier:
                type: string
              drug_tier_slug:
                type: string
              prior_authorization:
                type: boolean
                nullable: true
              step_therapy:
                type: boolean
                nullable: true
              quantity_limit:
                type: boolean
                nullable: true
            required: [formulary_id, formulary_uri, plan_id, year, plan_marketing_name, state, issuer, drug_tier, drug_tier_slug]
            additionalProperties: false
      required: [rxnorm_id, formularies]
      additionalProperties: false
    PlanDrugCoverage:
      type: object
      properties:
        formulary_id:
          type: string
        formulary_uri:
          type: string
        plan_id:
          type: string
        year:
          type: integer
        rxnorm_id:
          type: string
        covered:
          type: boolean
        details:
          $ref: '#/components/schemas/FormularyDrug'
      required: [formulary_id, formulary_uri, plan_id, year, rxnorm_id, covered]
      additionalProperties: false
    FormularyStatistics:
      type: object
      properties:
        total_formularies:
          type: integer
        total_drugs:
          type: integer
        top_issuers:
          type: array
          items:
            type: object
            properties:
              issuer_id:
                type: integer
              issuer_name:
                type: string
              drug_count:
                type: integer
            required: [issuer_id, issuer_name, drug_count]
            additionalProperties: false
        tier_distribution:
          type: array
          items:
            $ref: '#/components/schemas/TierBreakdownEntry'
        authorization_distribution:
          type: object
          properties:
            required:
              type: integer
            not_required:
              type: integer
          additionalProperties: false
      required: [total_formularies, total_drugs, top_issuers, tier_distribution, authorization_distribution]
      additionalProperties: false
    ImporterStats:
      type: object
      properties:
        plans_count:
          type: integer
        import_log_errors:
          type: integer
        import_date:
          type: string
          format: date-time
        issuers_number:
          type: integer
        issuers_by_state:
          type: object
          additionalProperties:
            type: integer
        plans_by_state:
          type: object
          additionalProperties:
            type: integer
    ImporterIssuerDetail:
      type: object
      properties:
        issuer_id:
          type: integer
        issuer_name:
          type: string
        import_errors_count:
          type: integer
        err_log:
          type: array
          items:
            type: object
            additionalProperties: true
      additionalProperties: true
    IssuerSummary:
      type: object
      properties:
        issuer_id:
          type: integer
        issuer_name:
          type: string
        state:
          type: string
        import_errors:
          type: integer
        plan_count:
          type: integer
      additionalProperties: true
    IssuerDetail:
      allOf:
        - $ref: '#/components/schemas/IssuerSummary'
        - type: object
          properties:
            plans:
              type: array
              items:
                type: object
                additionalProperties: true
            drug_summary:
              $ref: '#/components/schemas/IssuerDrugSummary'
    IssuerDrugSummary:
      type: object
      properties:
        total_drugs:
          type: integer
        authorization:
          type: object
          properties:
            required:
              type: integer
            not_required:
              type: integer
          additionalProperties: false
        step_therapy:
          type: object
          properties:
            required:
              type: integer
            not_required:
              type: integer
          additionalProperties: false
        quantity_limits:
          type: object
          properties:
            has_limit:
              type: integer
            no_limit:
              type: integer
          additionalProperties: false
        tiers:
          type: array
          items:
            $ref: '#/components/schemas/TierBreakdownEntry'
      required: [total_drugs, authorization, step_therapy, quantity_limits, tiers]
      additionalProperties: false
    GeoPingResponse:
      type: object
      properties:
        date:
          type: string
          format: date-time
        release:
          type: string
        environment:
          type: string
      additionalProperties: true
    GeoZipResponse:
      type: object
      properties:
        zip_code:
          type: string
        lat:
          type: number
        long:
          type: number
        state:
          type: string
        city:
          type: string
        state_name:
          type: string
        county_name:
          type: string
        timezone:
          type: string
      additionalProperties: false
    GeoCityResponse:
      type: object
      properties:
        normalized_city:
          type: string
        state:
          type: string
        items:
          type: array
          items:
            type: object
            properties:
              zip_code:
                type: string
              state:
                type: string
              state_name:
                type: string
              city:
                type: string
              county_name:
                type: string
              lat:
                type: number
              long:
                type: number
              timezone:
                type: string
            additionalProperties: false
      additionalProperties: false
    GeoTopZip:
      type: object
      properties:
        zip_code:
          type: string
        city:
          type: string
        population:
          type: integer
        lat:
          type: number
        long:
          type: number
      required: [zip_code, city, population]
      additionalProperties: false
    GeoStateSummary:
      type: object
      properties:
        state:
          type: string
        state_name:
          type: string
          nullable: true
        zip_count:
          type: integer
        city_count:
          type: integer
        population:
          type: integer
        avg_lat:
          type: number
          nullable: true
        avg_long:
          type: number
          nullable: true
        top_zips:
          type: array
          items:
            $ref: '#/components/schemas/GeoTopZip'
      required: [state, zip_count, city_count, population, top_zips]
      additionalProperties: false
    GeoStateListResponse:
      type: object
      properties:
        generated:
          type: string
          format: date-time
        states:
          type: array
          items:
            $ref: '#/components/schemas/GeoStateSummary'
      required: [states]
      additionalProperties: false
    GeoStateCitiesResponse:
      type: object
      properties:
        state:
          type: string
        limit:
          type: integer
        items:
          type: array
          items:
            type: object
            properties:
              city:
                type: string
              state:
                type: string
              zip_count:
                type: integer
              population:
                type: integer
              avg_lat:
                type: number
              avg_long:
                type: number
            additionalProperties: false
      additionalProperties: false
    NuccTaxonomy:
      type: object
      properties:
        code:
          type: string
        classification:
          type: string
        specialization:
          type: string
      additionalProperties: true
    NpiIndexStatus:
      type: object
      properties:
        date:
          type: string
          format: date-time
        release:
          type: string
        environment:
          type: string
        product_count:
          type: integer
        import_log_errors:
          type: integer
    NpiCountResponse:
      type: object
      properties:
        rows:
          type: integer
    NpiSearchResponse:
      type: object
      properties:
        total:
          type: integer
        rows:
          type: array
          items:
            $ref: '#/components/schemas/NpiRecord'
    NpiRecord:
      type: object
      properties:
        npi:
          type: integer
        provider_organization_name:
          type: string
        provider_first_name:
          type: string
        provider_last_name:
          type: string
        do_business_as:
          type: array
          items:
            type: string
        taxonomy_list:
          type: array
          items:
            $ref: '#/components/schemas/NpiTaxonomy'
        taxonomy_group_list:
          type: array
          items:
            $ref: '#/components/schemas/NpiTaxonomyGroup'
        address_list:
          type: array
          items:
            $ref: '#/components/schemas/NpiAddress'
        other_name_list:
          type: array
          items:
            $ref: '#/components/schemas/NpiOtherName'
      additionalProperties: true
    NpiTaxonomy:
      type: object
      properties:
        healthcare_provider_taxonomy_code:
          type: string
        provider_license_number:
          type: string
        provider_license_number_state_code:
          type: string
        healthcare_provider_primary_taxonomy_switch:
          type: string
      additionalProperties: true
    NpiTaxonomyGroup:
      type: object
      additionalProperties: true
    NpiAddress:
      type: object
      properties:
        type:
          type: string
        first_line:
          type: string
        second_line:
          type: string
        city_name:
          type: string
        state_name:
          type: string
        postal_code:
          type: string
        country_code:
          type: string
        telephone_number:
          type: string
        fax_number:
          type: string
        formatted_address:
          type: string
        lat:
          type: number
        long:
          type: number
      additionalProperties: true
    NpiOtherName:
      type: object
      properties:
        other_provider_identifier:
          type: string
        other_provider_identifier_type_code:
          type: string
        other_provider_identifier_state:
          type: string
        other_provider_identifier_issuer:
          type: string
    NpiTaxonomyWithNucc:
      allOf:
        - $ref: '#/components/schemas/NpiTaxonomy'
        - type: object
          properties:
            nucc_taxonomy:
              $ref: '#/components/schemas/NuccTaxonomy'
    NpiPlansResponse:
      type: object
      properties:
        npi_data:
          type: array
          items:
            type: object
            properties:
              npi_info:
                type: object
                additionalProperties: true
              issuer_info:
                type: object
                additionalProperties: true
        plan_data:
          type: array
          items:
            type: object
        issuer_data:
          type: array
          items:
            type: object
    NpiNearResult:
      allOf:
        - $ref: '#/components/schemas/NpiRecord'
        - type: object
          properties:
            distance:
              type: number
              description: Distance in miles from the reference point
